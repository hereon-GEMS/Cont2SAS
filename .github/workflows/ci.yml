name: CI

on:
  push:
  pull_request:

jobs:
  build:
    name: Download Sassena
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Download Sassena
        run: |
          mkdir -p Sassena
          curl -L https://codebase.helmholtz.cloud/api/v4/projects/6801/packages/generic/sassena/v1.9.2-f31e3882/Sassena_CPU.AppImage \
            -o Sassena/Sassena.AppImage
          chmod +x Sassena/Sassena.AppImage

      - name: Upload Sassena artifact
        uses: actions/upload-artifact@v4
        with:
          name: sassena
          path: Sassena

  test:
    name: Run tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Sassena artifact
        uses: actions/download-artifact@v4
        with:
          name: sassena
          path: Sassena

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mpi-default-dev wget ghostscript

      - name: Setup AppImage environment
        run: |
          echo "APPIMAGE_EXTRACT_AND_RUN=1" >> $GITHUB_ENV

      - name: Install Miniforge
        run: |
          wget -O Miniforge3.sh \
            "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
          bash Miniforge3.sh -b -p "$HOME/conda"
          echo "$HOME/conda/bin" >> $GITHUB_PATH

      - name: Create and activate conda environment
        run: |
          source "$HOME/conda/etc/profile.d/conda.sh"
          conda env create -f environment.yml
          conda activate Cont2Sas
          conda install -y pytest
          export C2S_HOME=$GITHUB_WORKSPACE
          pytest -v -rsx
